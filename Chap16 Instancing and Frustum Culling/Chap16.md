# Chap16 인스턴싱과 절두체 선별 Instancing and Frustum Culling

인스턴싱은 한 장면에서 같은 물체를 여러 번 그리는 것을 말한다. 절두체 선별은 시야 밖의 물체들을 판정을 통해 렌더링하지 않는 것을 말한다.

## 목표

1. 하드웨어 인스턴싱을 구현하는 방법을 배운다.
2. 경계입체가 무엇이고 왜 유용한지 살펴보고, 경계입체를 생성하고 활용하는 방법에 익숙해진다.
3. 절두체 선별을 구현하는 방법을 파악한다.

## 16.1 하드웨어 인스턴싱

인스턴싱은 한 장면에서 같은 물체를 여러 번 위치, 방향, 재질 등을 다르게 해서 그리는 것을 의미한다.

동일한 물체를 여러 번 그려야 하는 경우 정점 버퍼와 인덱스 버퍼를 그대로 두고 월드 행렬과 텍스처, 재질 등만 다르게 설정해서 그리기 호출을 여러 번 하는 것이 효율적일 것이다. 하지만 이것은 결국 그리기 호출을 여러 번 해야 한다. 인스턴싱을 사용하면 그리기 호출을 한 번만 해서 여러 물체들을 그릴 수 있다.

### 16.1.1 인스턴싱 방식으로 기하구조 그리기

그동안은 DrawIndexedInstanced에서 인스턴스 개수를 1로 설정했다. 이 값을 변경하여 그리기 호출을 여러 번 할 수 있다.

### 16.1.2 인스턴스별 자료

Input layout을 생성할 때 InputSlotClass에 그동안은 PER_VERTEX_DATA를 지정했다. 여기에 PER_INSTANCE_DATA를 지정하면 자료가 인스턴스별로 정점 셰이더에 전달된다.

여기서는 구조적 버퍼를 만들어 각 인스턴스별로 필요한 데이터를 모두 전달하는 방법을 사용한다. 현재 인스턴스가 몇 번째인지를 알아내기 위해 SV_InstanceID 시맨틱을 사용한다. SV_InstanceID는 각 인스턴스별로 0, 1, 2 순으로 증가한다. 따라서 이를 인덱스로 활용하면 각 인스턴스별 자료를 조회할 수 있다.

## 16.2 경계입체와 절두체

절두체 선별을 위해서는 절두체와 경계입체(bounding volume)가 있어야 한다. 경계입체는 어떤 물체가 차지하는 공간을 근사하는 입체도형이다. 대표적으로 직육면체, 구 등이 있다.

### 16.2.1 DirectXMath의 충돌 라이브러리

DirectXMathCollision.h에는 다양한 충돌 판정을 수행하는 메서드들을 제공한다.

### 16.2.2 경계상자

경계상자는 주어진 메시를 밀접하게 감싸는 직육면체를 의미한다. 대표적으로 AABB(axis-aligned bounding box, 각 모서리가 축과 평행한 직육면체)가 잇다. 어떤 메시의 경계상자(bounding box)를 구하는 가장 쉬운 방법은 최소 x,y,z와 최대 x,y,z 좌표를 구하는 것이다. 이를 중심과 한 꼭짓점까지의 벡터로 표현하는 것도 가능하다. DirectXMath는 이 표현을 사용한다.

#### 16.2.2.1 AABB의 회전

AABB가 회전할 경우 모서리들이 축과 평행하지 않으므로 더 이상 AABB가 아니게 될 수 있다. 여기서 AABB를 다시 구하는 것이 하나의 방법이지만 이것은 더 큰 범위의 AABB가 만들어질 수 있다. 또 다른 방법은 유향 경계상자(OBB)를 만드는 것이다. 여기에는 추가적으로 회전에 대한 정보가 사원수 형태로 들어있다.

DirectXCollision에서는 경계상자들을 구하는 메서드를 지원한다.

### 16.2.3 경계구

경계구를 정확하게 구하는 것은 어려우므로 주로 근사하는 방법을 사용하는데, 그 방법은 경계구의 중심을 AABB의 중심으로 잡은 다음 반지름은 중심으로부터 가장 먼 정점까지의 거리로 정하는 것이다.

경계구를 다룰 때 주의해야할 것은 비례 변환을 했을 때 구의 크기가 변하고, 이 때 구 형태가 유지되지 않을 수도 있다는 것이다. 따라서 비례 변환을 했을 때는 구의 반지름에 비례 변환의 가장 큰 성분을 곱해야 한다. 아니면 아예 비례 변환을 할 일이 없도록 만드는 것도 하나의 방법이다.

### 16.2.4 절두체(각뿔대)

각뿔대는 수학적으로 6개의 평면으로 표현할 수 있다. 이 때 6개의 평면들의 법선이 모두 안쪽을 향하고 있다고 가정하자. 절두체의 평면은 카메라를 기준으로 했을 때 위, 아래, 왼쪽, 오른쪽, 가까운, 먼 평면으로 분류할 수 있다.

우선 view space 상에서의 절두체를 구해보자. NDC 공간은 모든 점들을 [-1, 1]X[-1, 1]X[0, 1]로 투영하므로 직육면체로 정의할 수 있다. 투영 행렬의 역행렬을 곱하면 원근 나누기를 먼저 수행한 좌표, 즉 [x/z,y/z,1,1/z]를 구할 수 있다. 이를 통해 절두체의 각 평면의 기울기를 구할 수 있을 것이다. 절두체의 위, 아래, 왼쪽, 오른쪽 평면의 기울기를 구할 수 있고, view space 기준으로 이 네 평면은 모두 원점을 지나므로 평면은 쉽게 구할 수 있다.

이번 예제에서는 절두체 판정을 local space 상에서 수행한다. 그러기 위해서 view matrix의 역행렬과(view matrix는 world space에서 view space상으로 변환) world matrix(local -> world)의 역행렬을 곱해 local space로 변환한다.

절두체와 구, 절두체와 AABB사이의 판정에 관한 것은 책 698~700페이지에 있으며, 이 판정들은 각각의 클래스(BoundingSphere, BoundingFrustum, BoundingBox)의 Contains 메서드로 구할 수 있다. 결과는 DISJOINT, INTERSECTS, CONTAINS 중 하나이다.

## 16.3 절두체 선별

물론 파이프라인 단계 중 절단 단계에서 절두체 밖의 삼각형들은 폐기되지만, 정점 셰이더, 테셀레이션 등 그 이전까지의 단계들을 거쳐야 한다. 따라서 어차피 렌더링되지 않을 물체들이라면 정점 셰이더로 넘겨주지 않는 것이 바람직할 것이다.

따라서, 렌더링을 수행하기 이전에 절두체 선별을 통해 렌더링할 대상을 제외할 수 있으면 성능이 향상된다.
