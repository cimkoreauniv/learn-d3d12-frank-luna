# 14. 테셀레이션 단계

테셀레이션은 주어진 기하구조를 더 작은 삼각형들로 분할하고, 새로 생긴 정점들의 위치를 조정하는 것이다. 처음부터 하이 폴리곤 메시를 사용하는 대신 테셀레이션을 사용하면 얻을 수 있는 장점들은 다음과 같다.

1. GPU상의 동적 LOD: 메시의 세부 수준을 카메라의 거리 등 여러 가지 요소에 따라서 조절하여 자원을 절약한다.
2. 효율적인 물리 및 애니메이션 계산: 물체의 물리, 애니메이션을 저다각형에서 계산한 다음 테셀레이션을 통해 고다각형 메시를 만들어낼 수 있다.
3. 메모리 절약: 메모리(RAM, VRAM, 디스크)에 저다각형 버전을 저장하고 GPU에서 테셀레이션을 하면 된다.

테셀레이션은 정점 셰이더와 기하 셰이더 사이의 단계에서 수행되며, 정점 셰이더>덮개 셰이더>테셀레이터>영역 셰이더>기하 셰이더 순으로 실행된다.

## 목표

1. 테셀레이션에 쓰이는 여러 종류의 패치 기본도형들을 파악한다.
2. 각 테셀레이션 단계가 무슨 일을 하고 무엇을 입력, 출력하는지 이해한다.
3. 덮개 셰이더 프로그램과 영역 셰이더 프로그램을 작성해서 기하구조를 테셀레이션하는 방법을 배운다.
4. 테셀레이션 사용 여부를 결정하는 여러 전략과 하드웨어 테셀레이션에 관련된 성능 고려사항들에 익숙해진다.
5. 베지에 곡선 및 곡면에 깔린 수학과 그것들을 테셀레이션 단계들에서 구현하는 방법을 배운다.

## 14.1 테셀레이션 기본도형 위상구조(Tessellation Primitive Topology)

테셀레이션을 하려면 입력 조립기 단계에 삼각형들을 제출하지 않고 제어점들로 이루어진 패치들을 제출한다. D3D12에서 제어점은 1개에서 32개까지 가능하다. 삼각형, 사각형은 각각 제어점이 3개, 4개인 패치로 간주할 수 있다. 그 이상의 제어점들은 베지에 곡선 등 다양한 도형들을 지원하기 위한 것이다.

### 14.1.1 테셀레이션과 정점 셰이더

테셀레이션이 활성화되면 정점 셰이더에는 제어점들이 입력된다. 그러면 정점 셰이더는 제어점을 위한 정점 셰이더로 작동한다. 즉, 테셀레이션의 전처리 단계이다.

## 14.2 덮개 셰이더(Hull Shader)

덮개 셰이더는 상수 덮개 셰이더, 제어점 덮개 셰이더의 두 종류로 구성된다. 전체적인 처리 과정은 다음과 같다.

### 14.2.1 상수 덮개 셰이더(constant hull shader)

상수 덮개 셰이더는 패치 하나를 입력받아 실행되고, 메시의 테셀레이션 계수(factor)를 출력한다. 계수는 테셀레이터가 패치를 얼마나 세분할 것인지를 결정한다. 테셀레이션 계수에 대한 더 자세한 설명은 책을 참고한다. 테셀레이션 계수가 크면 세분화를 많이 하고, 작으면 덜한다. 계수가 0이면 해당 패치는 폐기되고, 최댓값은 64이다. 따라서 패치가 절두체 밖에 있거나, 뒤쪽을 바라보고 있는 경우 패치를 폐기하는 형태로 최적화를 할 수 있다.

테셀레이션 계수를 결정하는데 참고하는 수치들은 다음과 같다.

1. 카메라와의 거리
2. 화면 영역 포괄도(screen area coverage): 화면의 픽셀들을 얼마나 차지하는지의 정도이다.
3. 방향: 물체의 윤곽선을 이루는 삼각형들을 세분화하면 물체가 더 그럴듯하게 보인다.
4. 표면 거칠기: 표면이 거칠수록 테셀레이션 정도를 높일 필요가 있다.

성능과 관련된 조언들은 다음과 같다.

1. 테셀레이션을 계산한 결과가 1(테셀레이션을 적용하지 않는 것과 동일)이면 테셀레이션 없이 그대로 렌더링하는 것이 성능상 이득이다.
2. 삼각형의 커버리지가 픽셀 8개 미만일 정도로 작으면 테셀레이션하지 않는 것이 좋다.
3. 테셀레이션을 사용하는 그리기 호출들을 일괄적으로 묶어서 처리한다.

### 14.2.2 제어점 덮개 셰이더

제어점 덮개 셰이더는 일련의 제어점들을 받아 일련의 제어점들을 출력한다. 입력 제어점의 개수와 출력 제어점의 개수가 일치할 필요는 없다. 예를 들면 제어점이 3개인 삼각형 패치를 제어점이 10개인 3차 베지에 삼각형 패치로 변형할 수 있는 것이다.

제어점 덮개 셰이더는 각 출력 제어점에 대해서 실행된다. 현재 제어점 덮개 셰이더가 처리하는 출력 제어점은 SV_OutputControlPointID 시맨틱을 통해서 알아낼 수 있다.

제어점 덮개 셰이더에는 여러 가지 특성을 적용할 수 있으며, 책 629페이지에 나와있다.

이번 장의 첫 번째 예제인 BasicTessellation에서는 제어점을 수정 없이 그대로 출력한다.

## 14.3 테셀레이터 단계

테셀레이터 단계에는 프로그래머가 관여하지 않고 자동으로 이루어진다.

테셀레이터는 오직 패치의 종류(domain)와 계수만 가지고 테셀레이션을 수행한다. 즉, 테셀레이터는 제어점에는 아무런 관심이 없다. 테셀레이터는 패치의 종류와 계수, 출력 형식(outputtopology)에 따라서 정점들과 기본도형들을 생성한 다음 각 정점들을 영역 셰이더에 상대적인 좌표의 형태로 전달해준다. 결국 테셀레이션 결과 생성된 정점들의 위치를 제어점들을 이용해 잘 조작하여 적절한 모양을 만들어야 한다. 결론적으로, 테셀레이터가 하는 역할은 좌표들의 생성이다.

## 14.4 영역 셰이더(Domain Shader)

영역 셰이더는 테셀레이터가 출력한 각 제어점에 대해서 실행된다. 즉, 테셀레이션 이후의 정점 셰이더이다. 따라서 여기서 월드 좌표계의 정점들을 동차 절단 공간으로 변환해야 한다.

영역 셰이더에 각 제어점을 전달할 때 제어점을 직접 전달하지는 않는다. 대신 테셀레이션 이전의 덮개 셰이더에서 출력한 정점들과 그 정점들에 대한 상대적인 좌표를 함께 전달한다. 그러면 실제 좌표를 계산을 통해 유도하면 된다. BasicTessellation 예제의 경우 제어점이 4개인 사각형을 테셀레이션하므로 bilinear interpolation, 즉 2차원 보간을 통해 실제 좌표를 유도할 수 있다.

사각형 패치의 경우 정점의 매개변수 좌표가 (u, v) 형태로 주어지고, 삼각형 패치의 경우 무게중심 좌표(u, v, w)가 주어진다.

영역 셰이더의 입력은 상수 덮개 셰이더가 출력한 테셀레이션 계수, 좌표, 제어점 덮개 셰이더가 출력한 제어점들이다. 매개변수에 이들을 모두 선언하되, 순서는 상관없다.

## 14.5 사각형 하나의 테셀레이션

사각형을 하나 만들고, 사각형 중심과 카메라의 위치 사이의 거리에 따라서 테셀레이션 계수를 0에서 64까지 조정한다. 이후 생성된 제어점의 높이를 언덕 생성시에 사용했던 삼각함수들의 조합으로 구한다.

## 14.6 삼차 베지에 사각형 패치

베지에 곡선과 곡면은 매개변수를 통해 좌표를 알아낼 수 있다는 점에서 테셀레이션에 사용할 수 있다.

앞의 BasicTessellation에서는 삼각함수를 이용해서 테셀레이션해서 생성된 정점들의 좌표를 지정했지만, 다양한 형태의 곡면에 대응시키기는 어려운 방법이다.

베지에 곡선과 곡면은 몇 개의 Control Point를 사용해서 다양한 형태를 만들어낼 수 있다.

### 14.6.1 베지에 곡선(Bezier Curve)

곡선이므로 하나의 매개변수 t에 대해 곡선을 정의한다.

선형 보간이란 매개변수 하나로 주어진 두 점 사이에 있는 하나의 점을 구하는 것이므로 두 점을 매개변수 기준으로 하나로 합치는 효과가 있다.

베지에 곡선은 인접한 2개의 점을 t에 대해 보간하는 것을 반복하여 하나의 점이 남을 때까지 반복하여 얻을 수 있다.

예를 들어, 3개의 점에 대한 베지에 곡선은 다음과 같이 정의된다.

$\mathrm{p}(t) = (1-t)((1-t)\mathrm{p}_0+t\mathrm{p}_1)+t((1-t)\mathrm{p}_1+t\mathrm{p}_2) = (1-t)^2\mathrm{p}_0+2(1-t)t\mathrm{p}_1+t^2\mathrm{p}_2$

이 식은 t에 대한 2차식(quadratic)이므로 이차 베지에 곡선이라고 부른다.

같은 방법으로 3차(cubic) 베지에 곡선은 다음과 같이 정의된다.

$\mathrm{p}(t) = (1-t)^3\mathrm{p}_0+3(1-t)^2t\mathrm{p}_1+3(1-t)t^2\mathrm{p}_2+t^3\mathrm{p}_3$

일반화시켜 n차 베지에 곡선에서 각 점에 대한 계수를 표현하면 다음과 같다.

$B^n_i(t) = {}_n\mathrm{C}_it^i(1-t)^{n-i}$

이를 베른슈타인 기저(Bernstein basis)라고 부른다.

### 14.6.2 삼차 베지에 곡면

이제 매개변수를 2개(u, v)로 확장해보자.

일단 u에 대해서 베지에 곡선을 4개 구성한 다음, 특정한 u에서 점을 4개 얻을 수 있고, 이 4개의 점을 제어점으로 하여 v에 대해 베지에 곡선을 그리는 것이다.

그러면 총 16개의 제어점을 통해 베지에 곡면을 구성할 수 있을 것이다.

법선 벡터를 구하고 싶다면 u, v에 대해 편미분을 한 다음 외적을 수행하면 된다.
